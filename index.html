<!DOCTYPE html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>
		AKIP傷害計算
	</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">	
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
body {
	 background-color: #121212;
	 color: #f1f1f1;
}
 .fixed-bottom-bar {
	 position: sticky;
	 bottom: 0;
	 left: 0;
	 width: 100%;
	 background-color: #1f1f1f;
	 border-top: 1px solid #333;
	 padding: 1rem;
	 z-index: 1030;
}
/* input.form-control, span.input-group-text, .form-control:focus, .form-select.option {
	 background-color: #2a2a2a;
	 color: #fff;
	 border: 1px solid #2a2a2a;
}
 .form-control::placeholder {
	 color: #fff;
}
 */
 html[data-bs-theme="dark"] input.form-control, .form-select {
	 border: none;
}
 html[data-bs-theme="dark"] span.input-group-text {
	 border: none;
	 background-color: var(--bs-body-bg);
}
</style>
</head>
    
    <body>
        <div class="container py-4">
            <h1 class="text-center mb-4">
                幻想神域全球服－傷害計算
            </h1>
            <form id="damageForm">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="skillPanel" class="form-label" data-bs-toggle="tooltip" data-bs-html="true"
                        title='<img src="https://images.plurk.com/348GYIdbzC3mAna1lCZl0E.png" width="200">'>
                            技能面板傷害 ❔
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="skillPanel" value="75555"
                            pattern="\d*" maxlength="10">
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('skillPanel')">
                                清空
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="damageHide" class="form-label">
                            實際表傷 (反算)
                        </label>
                        <input type="text" readonly class="form-control" id="damageHide" value="">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="skillLevel" class="form-label" data-bs-toggle="tooltip" data-bs-html="true"
                        title='<img src="https://images.plurk.com/3JqH1eg9xtnUMJIF04AbtD.png " width="150">'>
                            技能等級 ❔
                        </label>
                        <select id="skillLevel" class="form-select">
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="baseSkillDamage" class="form-label">
                            基礎技能傷害
                        </label>
                        <input type="text" readonly class="form-control" id="baseSkillDamage"
                        readonly>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="damagePercent" class="form-label" data-bs-toggle="tooltip"
                        data-bs-html="true" title='<img src="https://images.plurk.com/7zoFAw5qH6fr1bRBh63PIO.png" width="150">'>
                            傷害% ❔
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="damagePercent" value="100"
                            placeholder="0" pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('damagePercent')">
                                清空
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="skillDamagePercent" class="form-label" data-bs-toggle="tooltip"
                        data-bs-html="true" title='<img src="https://images.plurk.com/o19aE0jZTzbogOlJkAXm8.png" width="150">'>
                            技能傷害% ❔
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="skillDamagePercent" value="100"
                            placeholder="0" pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('skillDamagePercent')">
                                清空
                            </button>
                        </div>
                    </div>
                </div>
                <hr class="my-5">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="extraDamage" class="form-label">
                            技傷% (提高XX技能傷害%)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="extraDamage" value="" placeholder="0"
                            pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('extraDamage')">
                                清空
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="elementDamage" class="form-label">
                            屬傷% (XX屬性技能傷害提高%)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="elementDamage" value=""
                            placeholder="0" pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('elementDamage')">
                                清空
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="targetElementDamage" class="form-label">
                            對屬傷% (對XX屬性的傷害提高%)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="targetElementDamage" value=""
                            placeholder="0" pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('targetElementDamage')">
                                清空
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="mainWeaponDamage" class="form-label">
                            主武器傷% (主武器的傷害提高%)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="mainWeaponDamage" value=""
                            placeholder="0" pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('mainWeaponDamage')">
                                清空
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="weaponElementMatch">
                    <label class="form-check-label" for="weaponElementMatch">
                        武器屬性同技能屬性 (同屬性傷害提高20%)
                    </label>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="levelDiff" class="form-label">
                            等級差（自身 - 敵人）
                        </label>
                        <select id="levelDiff" class="form-select">
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="EleDmgTaken" class="form-label">
                            扣屬抗% (受到XX屬性的傷害提高%)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="EleDmgTaken" value="" placeholder="0"
                            pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('EleDmgTaken')">
                                清空
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="critDmg" class="form-label">
                            爆擊傷害%
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="critDmg" value="130" placeholder="0"
                            pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('critDmg')">
                                清空
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="targetBonus" class="form-label">
                            造傷% (對XX目標的傷害提高%)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="targetBonus" value="" placeholder="0"
                            pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('targetBonus')">
                                清空
                            </button>
                        </div>
                    </div>
                </div>
                <hr class="my-5">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="resist" class="form-label">
                            屬抗%
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="resist" value="" placeholder="0"
                            pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('resist')">
                                清空
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="defReduction" class="form-label">
                            防禦減傷%
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="defReduction" value="" placeholder="0"
                            pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('defReduction')">
                                清空
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="critResist" class="form-label">
                            受到爆擊傷害降低%
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="critResist" value="" placeholder="0"
                            pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('critResist')">
                                清空
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="finalReduce" class="form-label">
                            減傷% (受到XX的傷害降低%)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="finalReduce" value="" placeholder="0"
                            pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('finalReduce')">
                                清空
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="skillElementMatch">
                    <label class="form-check-label" for="skillElementMatch">
                        技能屬性同敵人屬性 (受到同屬性傷害降低25%)
                    </label>
                </div>
            </form>
            <form id="newDamageForm">
                <hr class="my-5">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="newSkillDmg" class="form-label">
                            技能面板傷害
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newSkillDmg" value="" pattern="\d*"
                            maxlength="10">
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('newSkillDmg')">
                                清空
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="newPanelDmg" class="form-label">
                            實際表傷 (反算)
                        </label>
                        <input type="text" readonly class="form-control" id="newPanelDmg" value="">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="newAddSkillDmg" class="form-label">
                            技傷% (提高XX技能傷害%)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newAddSkillDmg" value="" placeholder="0"
                            pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('newAddSkillDmg')">
                                清空
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="newElemDmg" class="form-label">
                            屬傷% (XX屬性技能傷害提高%)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newElemDmg" value="" placeholder="0"
                            pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('newElemDmg')">
                                清空
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="newTargetElemDmg" class="form-label">
                            對屬傷% (對XX屬性的傷害提高%)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newTargetElemDmg" value=""
                            placeholder="0" pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('newTargetElemDmg')">
                                清空
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="newWeaponDmg" class="form-label">
                            主武器傷% (主武器的傷害提高%)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newWeaponDmg" value="" placeholder="0"
                            pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('newWeaponDmg')">
                                清空
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="newCritDmg" class="form-label">
                            爆擊傷害%
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newCritDmg" value="" placeholder="0"
                            pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('newCritDmg')">
                                清空
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="newDealDmg" class="form-label">
                            造傷% (對XX目標的傷害提高%)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newDealDmg" value="" placeholder="0"
                            pattern="\d*" maxlength="3">
                            <span class="input-group-text">
                                %
                            </span>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput('newDealDmg')">
                                清空
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="fixed-bottom-bar">
            <div class="container">
                <div class="row text-center">
                    <div class="col-3">
                    </div>
                    <div class="col-6 text-center">
                        <div class="row">
                            <div class="col-12" id="critResult">
                                0
                            </div>
                            <div class="col-12" id="critMinMax">
                                (0 ~ 0)
                            </div>
                            <div class="col-12" id="newBonus">
                            </div>
                        </div>
                    </div>
                    <div class="col-3 text-end">
                        <button class="btn btn-outline-light btn-sm" onclick="copyTo()">
                            <i class="bi bi-copy">
                            </i>
                        </button>
                    </div>
                </div>
                <div class="row text-center">
                    <div class="col-12 text-center">
                        <div id="AddDmgResult">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
let damageTable = {};
populateSelects();

fetch('skilldmg_table.json')
  .then(response => response.json())
  .then(data => {
    damageTable = data;    
	populateSelects();
    calculateDamage();
	document.getElementById("skillLevel").value = "75";
	document.getElementById("levelDiff").value = "5";
  });
  
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl)
})  

function populateSelects() {
  const skillLevelSelect = document.getElementById('skillLevel');
  for (let i = 48; i <= 180; i++) {
    const option = document.createElement('option');
    option.value = option.textContent = i;
    skillLevelSelect.appendChild(option);
  }

  const levelDiffSelect = document.getElementById('levelDiff');
  for (let i = 20; i >= -20; i--) {
    const option = document.createElement('option');
    option.value = option.textContent = i;
    levelDiffSelect.appendChild(option);
  }
}

function clearInput(id) {
  document.getElementById(id).value = '';
  calculateDamage();  
  document.getElementById(id).focus();
}

const form = document.getElementById('damageForm');
form.addEventListener('input', calculateDamage);

function calculateDamage() {
  const get = id => parseFloat(document.getElementById(id).value) || 0;
  const getCheckbox = id => document.getElementById(id).checked;
  const setText = (id, value) => document.getElementById(id).textContent = value;
   
  const skillLevel = get('skillLevel');
  document.getElementById('baseSkillDamage').value = damageTable[skillLevel] || 0;  

  const base = damageTable[skillLevel] || 0;
  const skillPanel = get('skillPanel');
  const dmgPct = get('damagePercent') / 100;
  const skillPct = get('skillDamagePercent') / 100;
  const tech = get('extraDamage') / 100;
  const elem = get('elementDamage') / 100;
  const elem2 = get('targetElementDamage') / 100;
  const weapon = get('mainWeaponDamage') / 100;
  const weleMatch = getCheckbox('weaponElementMatch') ? 0.2 : 0;
  const resistMatch = getCheckbox('skillElementMatch') ? 0.25 : 0;
  const lvDiff = get('levelDiff') * 0.005;
  const resist = get('resist') / 100;
  const def = get('defReduction') / 100;
  const crit = (get('critDmg') - get('critResist')) / 100;
  const bonus = 1 + get('targetBonus') / 100;
  const reduce = 1 - get('finalReduce') / 100;
  const EleDmgTaken = get('EleDmgTaken') / 100;
  
  document.getElementById('damageHide').value = Math.round((skillPanel - (base * skillPct)) / dmgPct, 0);
  let damageHide = get('damageHide');

  let raw = (base * skillPct + damageHide * (dmgPct + tech + elem + elem2 + weapon + weleMatch + EleDmgTaken + lvDiff - resist - def - resistMatch));
  let nonCritAvg = raw * bonus * reduce;
  let critAvg = raw * crit * bonus * reduce;

  const fmt = n => Math.round(n).toLocaleString();  
  //setText('critResult', `平均：${fmt(critAvg)}（${fmt(critAvg * 0.9)} ~ ${fmt(critAvg * 1.1)})`);
  setText('critResult',fmt(critAvg));
  setText('critMinMax', `(${fmt(critAvg * 0.9)} ~ ${fmt(critAvg * 1.1)})`);
}

function copyTo() {
  const get = id => parseFloat(document.getElementById(id).value) || 0;
  
  const base = damageTable[skillLevel] || 0;
  const dmgPct = get('damagePercent') / 100;
  const skillPct = get('skillDamagePercent') / 100;
  const skillPanel = get('skillPanel');  
  const tech = get('extraDamage');
  const elem = get('elementDamage');
  const elem2 = get('targetElementDamage');
  const weapon = get('mainWeaponDamage');
  const crit = get('critDmg');
  const bonus = get('targetBonus');
    
  document.getElementById('newPanelDmg').value = Math.round((skillPanel - (base * skillPct)) / dmgPct, 0);  
  document.getElementById('newSkillDmg').value = skillPanel;
  document.getElementById('newAddSkillDmg').value = tech;
  document.getElementById('newElemDmg').value = elem;
  document.getElementById('newTargetElemDmg').value = elem2;
  document.getElementById('newWeaponDmg').value = weapon;
  document.getElementById('newCritDmg').value = crit;
  document.getElementById('newDealDmg').value = bonus;
}

const form2 = document.getElementById('newDamageForm');
form2.addEventListener('input', calculateAddDmg);

function calculateAddDmg() {
  const get = id => parseFloat(document.getElementById(id).value) || 0;
  const getCheckbox = id => document.getElementById(id).checked;
  const setText = (id, value) => document.getElementById(id).textContent = value;
  
  const skillLevel = get('skillLevel');
  document.getElementById('baseSkillDamage').value = damageTable[skillLevel] || 0;  

  const base = damageTable[skillLevel] || 0;
  const skillPanel = get('skillPanel');
  const dmgPct = get('damagePercent') / 100;
  const skillPct = get('skillDamagePercent') / 100;
  const tech = get('extraDamage') / 100;
  const elem = get('elementDamage') / 100;
  const elem2 = get('targetElementDamage') / 100;
  const weapon = get('mainWeaponDamage') / 100;
  const weleMatch = getCheckbox('weaponElementMatch') ? 0.2 : 0;
  const resistMatch = getCheckbox('skillElementMatch') ? 0.25 : 0;
  const lvDiff = get('levelDiff') * 0.005;
  const resist = get('resist') / 100;
  const def = get('defReduction') / 100;
  const crit = (get('critDmg') - get('critResist')) / 100;
  const bonus = 1 + get('targetBonus') / 100;
  const reduce = 1 - get('finalReduce') / 100;
  const EleDmgTaken = get('EleDmgTaken') / 100;
  
  document.getElementById('damageHide').value = Math.round((skillPanel - (base * skillPct)) / dmgPct, 0);
  let damageHide = get('damageHide');
  
  const newPanelDmg = get('newPanelDmg');
  const newSkillDmg = get('newSkillDmg');  
  const newAddSkillDmg = get('newAddSkillDmg') / 100;
  const newElemDmg = get('newElemDmg') / 100;
  const newTargetElemDmg = get('newTargetElemDmg') / 100;
  const newWeaponDmg = get('newWeaponDmg') / 100;
  const newCritDmg = (get('newCritDmg') - get('critResist')) / 100;
  const newDealDmg = 1 + get('newDealDmg') / 100;  
  
  document.getElementById('newPanelDmg').value = Math.round((newSkillDmg - (base * skillPct)) / dmgPct, 0);
  let newDamageHide = get('newPanelDmg');

  let raw = (base * skillPct + damageHide * (dmgPct + tech + elem + elem2 + weapon + weleMatch + EleDmgTaken + lvDiff - resist - def - resistMatch));  
  let critAvg = raw * crit * bonus * reduce;
  
  let newraw = (base * skillPct + newDamageHide * (dmgPct + newAddSkillDmg + newElemDmg + newTargetElemDmg + newWeaponDmg + weleMatch + EleDmgTaken + lvDiff - resist - def - resistMatch));  
  let newcritAvg = newraw * newCritDmg * newDealDmg * reduce;  
  
  const label = document.getElementById('newBonus');
  let num1 = newcritAvg - critAvg;
  let num2 = critAvg;
  if (isNaN(num1) || isNaN(num2) || num2 === 0) {
	label.textContent = '無效';
	label.className = 'text-danger fw-bold';
	return;
  }  
  const percent = ((num1 / num2) * 100).toFixed(2); // 保留兩位小數
  label.textContent = (percent >= 0 ? "+" : "")+`${percent}%`;
  
  if (percent >= 0) {
	label.className = 'text-success fw-bold'; // 綠色
  } else {
	label.className = 'text-danger fw-bold'; // 紅色
  }
}
        </script>
    </body>
</html>