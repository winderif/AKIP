<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>遊戲傷害計算器</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #121212;
      color: #f1f1f1;
    }
    .fixed-bottom-bar {
      position: sticky;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #1f1f1f;
      border-top: 1px solid #333;
      padding: 1rem;
      z-index: 1030;
    }
    input.form-control, span.input-group-text, .form-control:focus {
      background-color: #2a2a2a;
      color: #fff;
      border: 1px solid #2a2a2a;
    }
	.form-control::placeholder {
		color: #fff;		
	}
  </style>
</head>
<body>
<div class="container py-4">
  <h1 class="text-center mb-4">幻想神域全球服－傷害計算</h1>

  <form id="damageForm">
    <div class="row mb-3">	  
      <div class="col-md-6">        
		<label for="panelDamage" class="form-label">人物面板傷害</label>
		<div class="input-group">
			<input type="number" class="form-control" id="panelDamage" value="74058" maxlength="6">			
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('panelDamage')">清除</button>
		</div>
      </div>
	  <div class="col-md-6">
        <label for="skillPanel" class="form-label" data-bs-toggle="tooltip" data-bs-html="true" title='<img src="https://images.plurk.com/348GYIdbzC3mAna1lCZl0E.png" width="200">'>技能面板傷害 ❔</label>
		<div class="input-group">
			<input type="number" class="form-control" id="skillPanel" value="75555" >			
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('skillPanel')">清除</button>
		</div>
      </div>      
    </div>
    <div class="row mb-3">
      <div class="col-md-6">
        <label for="skillLevel" class="form-label" data-bs-toggle="tooltip" data-bs-html="true" title='<img src="https://images.plurk.com/3JqH1eg9xtnUMJIF04AbtD.png " width="150">'>技能等級 ❔</label>
        <select id="skillLevel" class="form-select"></select>
      </div>
      <div class="col-md-6">
        <label for="baseSkillDamage" class="form-label">基礎技能傷害</label>
        <input type="number" readonly class="form-control" id="baseSkillDamage" readonly>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6">
        <label for="damagePercent" class="form-label" data-bs-toggle="tooltip" data-bs-html="true" title='<img src="https://images.plurk.com/7zoFAw5qH6fr1bRBh63PIO.png" width="150">'>傷害% ❔</label>
		<div class="input-group">
			<input type="number" class="form-control" id="damagePercent" value="100" placeholder="0">
			<span class="input-group-text">%</span>
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('damagePercent')">清除</button>
		</div>
      </div>
      <div class="col-md-6">
        <label for="skillDamagePercent" class="form-label" data-bs-toggle="tooltip" data-bs-html="true" title='<img src="https://images.plurk.com/o19aE0jZTzbogOlJkAXm8.png" width="150">'>技能傷害% ❔</label>
		<div class="input-group">
			<input type="number" class="form-control" id="skillDamagePercent" value="100" placeholder="0">
			<span class="input-group-text">%</span>
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('skillDamagePercent')">清除</button>
		</div>
      </div>
    </div>
	<div class="row mb-3">
		<div class="col-md-6">
			<label for="damageHide" class="form-label">實際表傷 (反算)</label>
			<input type="number" readonly class="form-control" id="damageHide" value="">	
		</div>
		<div class="col-md-6">
		</div>
	</div>
	<hr class="my-5">
    <div class="row mb-3">
      <div class="col-md-6">
        <label for="extraDamage" class="form-label">技傷% (提高XX技能傷害%)</label>
		<div class="input-group">
			<input type="number" class="form-control" id="extraDamage" value="0" placeholder="0">
			<span class="input-group-text">%</span>
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('extraDamage')">清除</button>
		</div>
      </div>
      <div class="col-md-6">
        <label for="elementDamage" class="form-label">屬傷% (XX屬性技能傷害提高%)</label>
		<div class="input-group">
			<input type="number" class="form-control" id="elementDamage" value="10" placeholder="0">
			<span class="input-group-text">%</span>
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('elementDamage')">清除</button>
		</div>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6">
        <label for="targetElementDamage" class="form-label">對屬傷% (對XX屬性的傷害提高%)</label>
		<div class="input-group">
			<input type="number" class="form-control" id="targetElementDamage" value="10" placeholder="0">
			<span class="input-group-text">%</span>
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('targetElementDamage')">清除</button>
		</div>
      </div>
      <div class="col-md-6">
        <label for="mainWeaponDamage" class="form-label">主武器傷% (主武器的傷害提高%)</label>
		<div class="input-group">
			<input type="number" class="form-control" id="mainWeaponDamage" value="0" placeholder="0">
			<span class="input-group-text">%</span>
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('mainWeaponDamage')">清除</button>
		</div>
      </div>
    </div>
	<div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="weaponElementMatch">
      <label class="form-check-label" for="weaponElementMatch">武器屬性同技能屬性 (同屬性傷害提高20%)</label>
    </div>
	<div class="row mb-3">
	  <div class="col-md-6">
        <label for="levelDiff" class="form-label">等級差（自身 - 敵人）</label>
        <select id="levelDiff" class="form-select"></select>
      </div>
	  <div class="col-md-6">        
		<label for="EleDmgTaken" class="form-label">扣屬抗% (受到XX屬性的傷害提高%)</label>
		<div class="input-group">
			<input type="number" class="form-control" id="EleDmgTaken" value="0" placeholder="0">
			<span class="input-group-text">%</span>
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('EleDmgTaken')">清除</button>
		</div>
      </div>
	</div>
    <div class="row mb-3">      
      <div class="col-md-6">
        <label for="critDmg" class="form-label">爆擊傷害%</label>
		<div class="input-group">
			<input type="number" class="form-control" id="critDmg" value="130" placeholder="0">
			<span class="input-group-text">%</span>
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('critDmg')">清除</button>
		</div>
      </div>
	  <div class="col-md-6">
        <label for="targetBonus" class="form-label">造傷% (對XX目標的傷害提高%)</label>
		<div class="input-group">
			<input type="number" class="form-control" id="targetBonus" value="10" placeholder="0">
			<span class="input-group-text">%</span>
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('targetBonus')">清除</button>
		</div>
      </div>
    </div>
	<hr class="my-5">
	<div class="row mb-3">      
      <div class="col-md-6">
        <label for="resist" class="form-label">屬抗%</label>
		<div class="input-group">
			<input type="number" class="form-control" id="resist" value="0" placeholder="0">
			<span class="input-group-text">%</span>
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('resist')">清除</button>
		</div>
      </div>
	  <div class="col-md-6">
        <label for="defReduction" class="form-label">防禦減傷%</label>
		<div class="input-group">
			<input type="number" class="form-control" id="defReduction" value="0" placeholder="0">
			<span class="input-group-text">%</span>
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('defReduction')">清除</button>
		</div>
      </div>
    </div>
    <div class="row mb-3">      
      <div class="col-md-6">
        <label for="critResist" class="form-label">受到爆擊傷害降低%</label>
		<div class="input-group">
			<input type="number" class="form-control" id="critResist" value="0" placeholder="0">
			<span class="input-group-text">%</span>
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('critResist')">清除</button>
		</div>
      </div>
	  <div class="col-md-6">
		<label for="finalReduce" class="form-label">減傷% (受到XX的傷害降低%)</label>
		<div class="input-group">
			<input type="number" class="form-control" id="finalReduce" value="0" placeholder="0">
			<span class="input-group-text">%</span>
			<button class="btn btn-outline-secondary" type="button" onclick="clearInput('finalReduce')">清除</button>
		</div>
	  </div>
    </div>
	<div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="skillElementMatch">
      <label class="form-check-label" for="skillElementMatch">技能屬性同敵人屬性 (受到同屬性傷害降低25%)</label>
    </div>
  </form>
</div>

<div class="fixed-bottom-bar">
  <div class="container">
    <div class="row text-center">
      <div class="col-md-6 mb-2 mb-md-0">
        <h5 class="mb-1">🔥 實際傷害（非爆）</h5>
        <div id="nonCritResult">平均：0（0 ~ 0）</div>
      </div>
      <div class="col-md-6">
        <h5 class="mb-1">💥 實際傷害（爆擊）</h5>
        <div id="critResult">平均：0（0 ~ 0）</div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let damageTable = {};

fetch('skilldmg_table.json')
  .then(response => response.json())
  .then(data => {
    damageTable = data;    
	populateSelects();
    calculateDamage();
  });
  
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl)
})  

function populateSelects() {
  const skillLevelSelect = document.getElementById('skillLevel');
  for (let i = 48; i <= 180; i++) {
    const option = document.createElement('option');
    option.value = option.textContent = i;
    skillLevelSelect.appendChild(option);
  }

  const levelDiffSelect = document.getElementById('levelDiff');
  for (let i = 20; i >= -20; i--) {
    const option = document.createElement('option');
    option.value = option.textContent = i;
    levelDiffSelect.appendChild(option);
  }
}

function clearInput(id) {
  document.getElementById(id).value = '';
  calculateDamage();
}

const form = document.getElementById('damageForm');
form.addEventListener('input', calculateDamage);

function calculateDamage() {
  const get = id => parseFloat(document.getElementById(id).value) || 0;
  const getCheckbox = id => document.getElementById(id).checked;
  const setText = (id, value) => document.getElementById(id).textContent = value;
   
  const skillLevel = get('skillLevel');
  document.getElementById('baseSkillDamage').value = damageTable[skillLevel] || 0;  

  const base = damageTable[skillLevel] || 0;
  const panel = get('panelDamage');
  const skillPanel = get('skillPanel');
  const dmgPct = get('damagePercent') / 100;
  const skillPct = get('skillDamagePercent') / 100;
  const tech = get('extraDamage') / 100;
  const elem = get('elementDamage') / 100;
  const elem2 = get('targetElementDamage') / 100;
  const weapon = get('mainWeaponDamage') / 100;
  const weleMatch = getCheckbox('weaponElementMatch') ? 0.2 : 0;
  const resistMatch = getCheckbox('skillElementMatch') ? 0.25 : 0;
  const lvDiff = get('levelDiff') * 0.005;
  const resist = get('resist') / 100;
  const def = get('defReduction') / 100;
  const crit = (get('critDmg') - get('critResist')) / 100;
  const bonus = 1 + get('targetBonus') / 100;
  const reduce = 1 - get('finalReduce') / 100;
  const EleDmgTaken = get('EleDmgTaken') / 100;
  
  document.getElementById('damageHide').value = Math.round((skillPanel - (base * skillPct)) / dmgPct, 0);
  let damageHide = get('damageHide');

  let raw = (base * skillPct + damageHide * (dmgPct + tech + elem + elem2 + weapon + weleMatch + EleDmgTaken + lvDiff - resist - def - resistMatch));
  let nonCritAvg = raw * bonus * reduce;
  let critAvg = raw * crit * bonus * reduce;

  const fmt = n => Math.round(n).toLocaleString();
  setText('nonCritResult', `平均：${fmt(nonCritAvg)}（${fmt(nonCritAvg * 0.9)} ~ ${fmt(nonCritAvg * 1.1)})`);
  setText('critResult', `平均：${fmt(critAvg)}（${fmt(critAvg * 0.9)} ~ ${fmt(critAvg * 1.1)})`);
}
</script>

</body>
</html>
